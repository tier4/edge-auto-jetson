- name: Get file info from GitHub repository
  ansible.builtin.uri:
    url: "{{ camera_driver_repo }}"
  register: github_api_return_info

- name: Parse download URL for driver
  loop: "{{ github_api_return_info.json.assets }}"
  ansible.builtin.set_fact:
    driver_deb_download_url: "{{ item.browser_download_url }}"
    driver_deb_name: "{{ item.name }}"
  when: item.name | regex_search('tier4-camera-gmsl_(.+)_arm64.deb')

- name: Download driver deb file from public repo
  ansible.builtin.uri:
    url: "{{ driver_deb_download_url }}"
    dest: "{{ camera_driver_download_dir }}/{{ driver_deb_name }}"
    mode: 064
    status_code: [200, 304]

- name: Install apt packages
  become: true
  ansible.builtin.apt:
    name:
      - make
      - build-essential
      - debhelper
      - debmake
      - devscripts
      - dkms
    update_cache: true

- name: Unpack camera driver deb without triggering postinst
  block:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes
      become: true

    - name: Unpack deb
      ansible.builtin.command: |
        dpkg --unpack "{{ camera_driver_download_dir }}/{{ driver_deb_name }}"
      register: driver_deb_unpack_result
      become: true
      changed_when: driver_deb_unpack_result.rc == 0
      failed_when: false

    - name: Hold the deb configuration
      ansible.builtin.command: |
        apt-mark hold tier4-camera-gmsl
      register: driver_apt_mark_result
      become: true
      changed_when: driver_apt_mark_result.rc == 0
      failed_when: false

- name: Copy device tree overlay file to /boot (overwrite if exists)
  become: true
  ansible.builtin.copy:
    src: tier4-imx490-gmsl-device-tree-overlay-anvil-r36.dtbo
    dest: /boot/tier4-imx490-gmsl-device-tree-overlay-anvil-r36.dtbo
    mode: "0644"
    owner: root
    group: root

- name: Copy tier4-imx490.conf to /etc/modprobe.d (overwrite if exists)
  become: true
  ansible.builtin.copy:
    src: tier4-imx490.conf
    dest: /etc/modprobe.d/tier4-imx490.conf
    mode: "0644"
    owner: root
    group: root

- name: Create camera driver installer script
  become: true
  ansible.builtin.template:
    src: camera-driver-installer.sh.j2
    dest: /usr/local/bin/camera-driver-installer.sh
    mode: "0755"
    owner: root
    group: root

- name: Create systemd service file
  become: true
  ansible.builtin.template:
    src: camera-driver-installer.service.j2
    dest: /etc/systemd/system/camera-driver-installer.service
    mode: "0644"
    owner: root
    group: root

- name: Enable camera driver installer service
  become: true
  block:
    - name: Create systemd service directory if it doesn't exist
      ansible.builtin.file:
        path: /etc/systemd/system/multi-user.target.wants
        state: directory
        mode: "0755"
        owner: root
        group: root

    - name: Create systemd enable symlink manually
      ansible.builtin.file:
        src: /etc/systemd/system/camera-driver-installer.service
        dest: /etc/systemd/system/multi-user.target.wants/camera-driver-installer.service
        state: link
        force: yes
        owner: root
        group: root
