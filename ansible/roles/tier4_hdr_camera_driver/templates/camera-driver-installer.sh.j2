#!/bin/bash
set -e

if ! grep -q "LABEL t4_primary_c2x8" /boot/extlinux/extlinux.conf; then
  cat >> /boot/extlinux/extlinux.conf << 'EOF'
LABEL t4_primary_c2x8
      MENU LABEL Custom Header Config: <CSI TIERIV GMSL2 Camera Device Tree Overlay: C2x8>
      LINUX /boot/Image
      INITRD /boot/initrd
      FDT /boot/dtb/kernel_tegra234-orin-agx-cti-AGX201.dtb
      OVERLAYS /boot/tier4-imx490-gmsl-device-tree-overlay-anvil-r36.dtbo
      APPEND ${cbootargs} root=/dev/mmcblk0p1 rw rootwait rootfstype=ext4 mminit_loglevel=4 console=ttyTCU0,115200 console=ttyAMA0,115200 firmware_class.path=/etc/firmware fbcon=map:0 nospectre_bhb video=efifb:off console=tty0
EOF
fi

sed -i 's/^DEFAULT primary/DEFAULT t4_primary_c2x8/' /boot/extlinux/extlinux.conf

systemctl disable camera-driver-installer.service

exit 0
